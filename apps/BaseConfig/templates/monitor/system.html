{% extends 'adminlte/lib/base.html' %}
{% block content %}
    <div id="app">
        <el-dialog title="创建" v-model="DialogCreateVisible">
            <el-form :model="CreateForm">
                <el-form-item label="系统名">
                    <el-input v-model="CreateForm.SystemName" placeholder="请输入系统名"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="DialogCreateVisible = false">取 消</el-button>
                <el-button type="primary" @click="handleCreate">确 定</el-button>
            </div>
        </el-dialog>
        <el-dialog title="系统详情" v-model="DialogDetailVisible">
            <span>ID:  </span>
            <el-tag type="primary">[[ Detail.Id ]]</el-tag>
            <br/>
            <span>系统名:  </span>
            <el-tag type="primary">[[ Detail.Name ]]</el-tag>
            <br/>
            <span>创建时间:  </span>
            <el-tag type="primary">[[ Detail.CreateTime ]]</el-tag>
            <br/>
            <span>修改时间:  </span>
            <el-tag type="primary">[[ Detail.ChangeTime ]]</el-tag>
            <br/>
            <el-table :data="DetailTable">
                <el-table-column prop="Id" label="实例Id" width="150"></el-table-column>
                <el-table-column prop="Name" label="实例名" width="200"></el-table-column>
                <el-table-column prop="Note" label="备注" width="200"></el-table-column>
            </el-table>
            <div slot="footer" class="dialog-footer">
                <el-button @click="DialogDetailVisible = false">取 消</el-button>
                <el-button type="primary" @click="DialogDetailVisible = false">确 定</el-button>
            </div>
        </el-dialog>
        <el-row>
            <el-col :span="24">
                <el-card class="box-card" style="margin-bottom:  5px;">
                    <div slot="header" class="clearfix">
                        <span style="font-size: 20px;">系统</span>
                        <el-button style="float: right;" @click="DialogCreateVisible = true" type="primary">创建
                        </el-button>
                    </div>
                    <el-form :model="SearchForm" :inline="true" class="demo-form-inline" la>
                        <el-form-item label="系统名">
                            <el-input v-model="SearchForm.SystemName" placeholder="系统名"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="onSearch">查询</el-button>
                        </el-form-item>
                    </el-form>
                </el-card>
            </el-col>
        </el-row>
        <el-row>
            <el-col :span="24">
                <el-table
                        :data="tableData"
                        style="width: 100%">
                    <el-table-column
                            label="ID"
                            prop="Id"
                            width="100">
                    </el-table-column>
                    <el-table-column
                            label="系统名"
                            width="180"
                            prop="Name"
                    >
                    </el-table-column>
                    <el-table-column
                            label="创建时间"
                            width="180"
                            prop="CreateTime"
                    >
                        <template scope="scope">
                            <el-icon name="time"></el-icon>
                            <span style="margin-left: 10px">[[ scope.row.CreateTime ]]</span>
                        </template>
                    </el-table-column>
                    <el-table-column
                            label="修改时间"
                            width="180"
                            prop="ChangeTime"
                    >
                        <template scope="scope">
                            <el-icon name="time"></el-icon>
                            <span style="margin-left: 10px">[[ scope.row.ChangeTime ]]</span>
                        </template>
                    </el-table-column>
                    <el-table-column
                            label="备注"
                            width="180"
                            prop="Note"
                    >
                    </el-table-column>
                    <el-table-column label="操作">
                        <template scope="scope">
                            <el-button
                                    size="small"
                                    icon="document"
                                    type="primary"
                                    @click="handleDetail(scope.$index, scope.row)">
                            </el-button>
                            <el-button
                                    size="small"
                                    icon="edit"
                                    type="primary"
                                    @click="handleEdit(scope.$index, scope.row)">
                            </el-button>
                            <el-button
                                    size="small"
                                    icon="delete"
                                    type="primary"
                                    type="danger"
                                    @click="handleDelete(scope.$index, scope.row)">
                            </el-button>
                        </template>
                    </el-table-column>

                </el-table>
                <template>
                    <el-pagination
                            :page-size="15"
                            @current-change="handleCurrentChange"
                            layout="prev, pager, next, jumper, ->, total, slot"
                            :total="count">
                    </el-pagination>
                </template>
            </el-col>
        </el-row>

    </div>

    <script>
        function getCookie(name) {
            var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)"); //正则匹配
            if (arr = document.cookie.match(reg)) {
                return unescape(arr[2]);
            }
            else {
                return null;
            }
        }
        new Vue({
            el: '#app',
            data: {
                tableData: [],
                SearchForm: {
                    SystemName: ''
                },
                CreateForm: {},
                Detail: {},
                DetailTable: [],
                DialogDetailVisible: false,
                DialogCreateVisible: false,
                count: 0,
                currentPage: 1,
                visible2: false
            },
            created: function () {
                NProgress.start();
                this.$http.get('/api/system/list/').then(function (response) {
                    this.tableData = response.body.results;
                    this.count = response.body.count;
                    NProgress.done();
                }, function (response) {
                    this.$message({
                        showClose: true,
                        message: response.body.detail,
                        type: 'error'
                    });
                    NProgress.done();
                });

            },
            methods: {
                handleCreate: function () {
                    this.DialogCreateVisible = false;
                    this.CreateForm = {}
                },
                onSearch: function () {
                    NProgress.start();
                    this.$http.get('/api/system/list/' + "?search=" + this.SearchForm.SystemName).then(function (response) {
                        this.tableData = response.body.results;
                        this.count = response.body.count;
                        NProgress.done();
                    }, function (response) {
                        this.$message({
                            showClose: true,
                            message: response.body.detail,
                            type: 'error'
                        });
                        NProgress.done();
                    });
                },
                // 分页
                handleCurrentChange: function (val) {
                    NProgress.start();
                    this.$http.get('/api/system/list/' + "?page=" + val).then(function (response) {
                        this.tableData = response.body.results;
                        this.count = response.body.count;
                        NProgress.done();
                    }, function (response) {
                        this.$message({
                            showClose: true,
                            message: response.body.detail,
                            type: 'error'
                        });
                        NProgress.done();
                    });
                },
                //详情
                handleDetail: function (index, row) {
                    this.DialogDetailVisible = true;
                    NProgress.start();
                    this.$http.get('/api/system/' + row.Id).then(function (response) {
                        this.Detail = response.body;
                        NProgress.done();
                    }, function (response) {
                        this.$message({
                            showClose: true,
                            message: response.body.detail,
                            type: 'error'
                        });
                        NProgress.done();
                    });
                    NProgress.start();
                    this.$http.get('/api/instantiation/list' + '?SystemId__Id=' + row.Id).then(function (response) {
                        this.DetailTable = response.body.results;
                        console.log(this.DetailTable)
                        NProgress.done();
                    }, function (response) {
                        this.$message({
                            showClose: true,
                            message: response.body.detail,
                            type: 'error'
                        });
                        NProgress.done();
                    });
                },
                // 编辑
                handleEdit: function (index, row) {
                    console.log(index, row);
                    this.$message('这是一条消息提示');
                },
                // 删除
                handleDelete: function (index, row) {
                    NProgress.start();
                    this.$http.delete('/api/system/' + row.Id, {
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken")
                        }
                    }).then(function (response) {
                        this.$message({
                            showClose: true,
                            message: '删除成功: ' + row.Name,
                            type: 'info'
                        });
                        NProgress.done();
                    }, function (response) {
                        this.$message({
                            showClose: true,
                            message: response.body.detail,
                            type: 'error'
                        });
                        NProgress.done();
                    });

                }
            },
            delimiters: ["[[", "]]"]
        })
    </script>
{% endblock %}